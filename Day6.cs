
using static System.Net.Mime.MediaTypeNames;
using System;

namespace advent_of_code_2024
{
    public class Position
    {
        public int X { get; set; }
        public int Y { get; set; }

        public List<int> Orientations { get; set; }

        public Position()
        {
            Orientations = new List<int>();
        }

        public Position(int x, int y)
        {
            X = x;
            Y = y;
            Orientations = new List<int>();
        }

        public override bool Equals(object? obj) => X == ((Position)obj).X && Y == ((Position)obj).Y;

        public override int GetHashCode() => HashCode.Combine(X, Y);
    }

    internal class Day6
    {
        public static void Run()
        {
            char[][] map = Input
                .Split('\n')
                .Select(line => line.Replace("\r", "").ToCharArray())
                .ToArray();

            Position initialPosition = new Position();

            // Initial position
            for (int x = 0; x < map[0].Length; x++)
            {
                for (int y = 0; y < map.Length; y++)
                {
                    if (map[y][x] != '^') continue;

                    initialPosition = new Position(x, y);
                }
            }

            // Movement
            Position guard = initialPosition;
            Position next = new Position();
            int orientation = 0;
            List<Position> loops = new List<Position>();
            List<Position> visited = new List<Position>() { guard };
            while (IsWithinBounds(map, guard))
            {
                next = Next(guard, orientation);

                if (!IsWithinBounds(map, next)) break;
                if (map[next.Y][next.X] == '#') orientation++;
                else
                {
                    guard = next;

                    // Searches for loops in current position
                    if (FindsNextOrientation(map, visited, guard, orientation + 1))
                    {
                        loops.Add(guard);
                        //loops++;
                    }

                    // Updates list of orientations for that position
                    Position visit = visited.SingleOrDefault(p => p.X == guard.X && p.Y == guard.Y);
                    if (visit == null)
                    {
                        guard.Orientations.Add(orientation);
                        visited.Add(guard);
                    }
                    else
                    {
                        visit.Orientations.Add(orientation);
                    }
                }

                if (orientation >= 4) orientation = 0;
            }

            Console.WriteLine("- Day 6:");
            Console.WriteLine("Part 1:");
            Console.WriteLine($"Unique visited positions: {visited.Distinct().Count()}");
            Console.WriteLine("Part 2:");
            Console.WriteLine($"Possible loops count: {loops.Distinct().Count()}");
        }

        private static bool IsWithinBounds(char[][] map, Position position) => position.X >= 0 && position.X < map.Length && position.Y >= 0 && position.Y < map[0].Length;

        private static Position Next(Position position, int orientation)
        {
            switch (orientation)
            {
                case 0: return new(position.X, position.Y - 1);
                case 1: return new(position.X + 1, position.Y);
                case 2: return new(position.X, position.Y + 1);
                case 3: default: return new(position.X - 1, position.Y);
            }
        }

        private static bool FindsNextOrientation(char[][] map, List<Position> visited, Position position, int orientation)
        {
            if (orientation >= 4) orientation = 0;
            Position next = Next(position, orientation);
            while (IsWithinBounds(map, next) && map[next.Y][next.X] != '#')
            {
                //if (!visited.Contains(next)) continue;
                if (visited.Contains(next) && visited.Single(visit => visit.Equals(next)).Orientations.Contains(orientation))
                {
                    return true;
                }


                next = Next(next, orientation);
            }

            return false;
        }

        public static string InputDummy =
            @"....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...";

        public static string Input =
            @"#.....#.........#.........................#...#....................#......#.......#...........#........#..........................
..................#......#..................................#..................#....#...............#.#....................#.....#
..............#...........#......#.#.......................................#..................#......#............................
##...............................#..........#...................#.......#................................................#........
#.....................#.......##................#...#..........#............................................#...#....#............
........#........#.............#...............#...##...................#...........#...........#.......#...........##.#...#.#....
................................................#....................................................#.#..........................
.........#....#.....................................................................##......#.....#........#...............#......
.............................#.....#.........#......................#...#................#.#..........#...........................
........................................#.........................................................................#...............
.........................................#.......#.............#.#.........................#....#.....#...........#...............
...#............##...................................#...........#........................................#..................#....
....#.................#.......#............#.....#...........#................................#.#.#...........................#...
...#................................................................#.......................#.#........................#..#...#...
............................#......#.......#...............................................................................#....#.
.......................................................#.............................#...#.......#.............#............#.....
.....................................................................#......................................#.................##..
......#.................#......................................................#................#.................................
...............................................................................#...............#............................#.....
........................................................#......................##..................#........#.....................
.#.................................#....#........#..#........#.................................#...............#..........#.#.....
.................#................#...................#.#.....#................#..................#.........#.....................
...............#........................................................................#............#..........#.................
....................#..................#...........#................................#.....................#...#......#............
.............#..#..................................#..............................#...............................#...#......#...#
..................#.............................................................#...............................#......#..........
................................................................#....#..............#.............................#...............
.............#............#............................#...#........#...#.........................##..............................
....................................#....#.............#...#....#..........................#..................#.#............#....
.......................#........................................................................................#.................
........#..................................#..#.........#.......................................#......#..............#...........
..........#............#............#..................#.......#..........#...................................#...........#.......
....#..............................#.....#...........##...#.....................#...........................#..........#..........
................................#..#.................................................................#...#...................#....
..#....................#..........................................................................#...............................
..................#........................#.......#..#......................................................................#....
.#.....#......................#.....................................#.........................................#...................
..#....#...........................................#..........................................................................#...
..#.....#........................................................................#........#.#.............................#.......
................#......................................#...............#....................................#..........#..........
....................................#........................##.............................#..........................#........#.
.#..............#..............................#......................................................#...........................
...#.#......................#.................#..................................#...........................#....................
..#....#..........................................#...#.......#..............................................#....................
.......#.................#............................#..................................................#..#....................#
.....##.#...........#...........................................#.....................................................#...........
................#.#........................................................................#..........#..#....#.##................
..........#........#............................................#.#......................................#.............#..........
............................................................#..........................................#..........................
.......#........#.................#....................................................................#..........................
........................................................#..........................#..............#...............................
.............#.#....................................#.................##............#.#.............................#..........#..
.##.............................................^........#...................#.....#...................................#..........
...............#..#..#................................................................#...........................#...............
.#.......##...........#.........#..................#......#..........#...#....#...................#...............................
....#................................................................#...................#........................................
.........#............#..#......................................................#..#..............................................
...#.............................................................#......#....#....................................#...#....#......
.....#.........#.................#....................#..................#..#.#.............#......#.....................#........
...........#.......#.##.#......#..#.............................#...........#..............................................#......
................................................................................................#.#......#......................#.
##..................................##....#.................#...............##....................................................
.....#.............................#.............................................#................#.....................#.........
............#..............................#.....................#...............#..#....#....#...................................
.........#.........................#...#................................................#........................................#
.#..........................................#.......#.....................................................#..............#...#....
#.........#...........#.............#..........................#........................................#.........................
.......................................................................#.............................................#............
....#..............#..#......................................................#..........................................#....#....
........#...................................#...#................#.........................................................#...#..
.........................................................#..#..#..#..........#...........#...........#............#...............
..............................................##......#.................#..............................................#..........
.............................#..........#......#.....#....#.............#..............................................#...#..#...
......................................##......#.....................................#.......#....................#................
...................................................................................................#..............................
.................................#..................................................................................#.............
........#...................................................................#...................##............#...................
...............................#..................................................................................................
...............................#...........................................................#...............##..............#......
........................................................................#..........#..................................#...........
................#.................................................................................................................
...#.................#..........#...........#...................................#......................#..........................
.......................#..........................................................#.............#.............#..........#........
..........#..........#.#.................................#........#.............#..#..........................#........#.........#
.................#.........#.#........................#...#.............................................................#......#..
......#.....................................................................#.....#...............#...............#....#..........
......#...##....#..#.......................................##......#......#....#..............#............#....................#.
.#..........#........#...#........##..............#....#...........................#.....#................#...................#...
.........................#........................................................................................................
..........................#.......................#.........#................................................#.#...........#......
......#...#.....#..........#....................#..................................#...#.................................#........
.......................................................#............................#.....................#.#.................#...
..............#...............#......................#......#...................#.....................#.........#................#
....#.........#...............................................................#.......#.......#...........#.................#.....
.......................#.........................#....................................#...........................................
...............#.................#..........#........................#...##.......................................................
....##..................#..#..................................................................................#.................#.
..................#.............#......................#...............#................#.#.......................................
........................#....#................................................#...#..........#....#.......#.......................
.........................................................#..............#.............#.#.......#..................#......#...#...
...........#...........................#.........#..................................#.....................................#.......
.#..........................................#................................................................#...........#........
..................................##....................#..........#..............#..........#............#.....#.................
##..#..#....#.........................................................#...............#...................................#.......
....#.#...........#............................#....#........#......#.............................................................
#....#.........................#.............#.............................................................#.....#..#.............
............................#......#................#...............................................#.....#............#..........
........................#.............#..................#........................................................................
..#.............#........................................#.................................................#......................
...................#...................#..........#..#.............................................#...........#...#............#.
....#...#..........................##...#...............#....#.....................................#............#.................
..............................#..............................................................###..................................
.................#......................................#.......................##.#............#.................................
............#.........................................#......##.....................#............#................................
....................#..#.............................#...#......................................#....................#.#........#.
....#...........#...........................................#....................................................#................
............#.....#..................................##.........#........#.....................................#..................
......#..............#..................................#...#.......#.............................................................
..........#.................#.......#.........................................................................#...........#.......
...........#..............#................#.....##.#............#........#.......................................................
................#.......................#.........................................................................#...........#...
..............................#............................................#.......#..............................................
..............#..............................#......#..................#....#.....#.................................#........#....
....................##..........#...#..#................#............#.......................#.................................#..
........................##.......#..................#.......#.....................#................#.....................#.....#..
..............#.............#...#......#.........#.................##..#...........#...........#.........................##.......
#........#...........#........#..#............#...........#....#....#......##..............................................#......
........................................#.....................#....................................#........#......#......#.......
.............#........#.............#...........#..#..#.......................................................#......#............
#...................#.#........................................#..................................#...#...........................";
    }
}
